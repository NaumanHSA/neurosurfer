name: Publish to PyPI
on:
  push:
    tags:
      - "v*.*.*"         # push a tag like v0.1.2
  workflow_dispatch:

permissions:
  id-token: write        # <-- required for OIDC
  contents: read

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Build the React UI and sync into neurosurfer/ui_build
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: neurosurferui/package-lock.json
      - name: Build UI â†’ neurosurfer/ui_build
        run: |
          chmod +x scripts/build_ui.sh
          ./scripts/build_ui.sh

      # Build the Python distribution (wheel + sdist)
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: python -m pip install --upgrade pip build
      - run: python -m build

      # Publish to PyPI via Trusted Publisher (no API token needed)
      - name: Publish (PyPI Trusted Publisher)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          print-hash: true
          # packages-dir: dist          # default is dist/
          # skip-existing: true         # optional
          # verify-metadata: true       # optional (recommended)

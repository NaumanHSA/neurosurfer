name: docgen_workflow
description: >
  Autonomously generate/upate Neurosurfer documentation and mkdocs.yml
  from the codebase and existing docs.

inputs:
  - project_root: str
  - docs_root: str
  - include_patterns:
      type: list
      required: false
  - exclude_patterns:
      type: list
      required: false
  - sections:
      type: list
      required: false
  - doc_template:
      type: string
      required: false
  - mode:
      type: string
      required: false

nodes:
  # 1) Scan the repo, understand folders/files
  - id: scan_repo
    purpose: >
      Walk the project_root and docs_root and build a structured index
      of packages, modules, and existing markdown docs.
    goal: >
      Produce a compact JSON description of the filesystem: python files,
      packages, modules, and existing docs.
    expected_result: >
      A JSON object with "packages", "modules", "python_files", "doc_files".
    tools: ["directory_scan"]
    mode: structured
    output_schema: neurosurfer.docs.schemas.DocRepoIndex
    export: true

  # 2) Build symbol index (optional but nice)
  - id: build_symbol_index
    depends_on: ["scan_repo"]
    purpose: >
      Create a high-level symbol index (modules, classes, functions) for
      key areas (agents, models, rag, server, cli).
    goal: >
      For the python files identified in scan_repo, build a structured
      symbol index that can drive API docs.
    expected_result: >
      A JSON object mapping modules to symbol lists and short descriptions.
    tools: ["code_symbol_index"]
    mode: structured
    output_schema: neurosurfer.docs.schemas.SymbolIndex
    export: true

  # 3) Plan docs structure
  - id: plan_docs
    depends_on: ["scan_repo", "build_symbol_index"]
    purpose: >
      Plan a documentation structure (pages, paths, titles) that reflects
      the current codebase and old mkdocs nav conventions.
    goal: >
      Suggest a set of DocPageSpec entries for all relevant areas:
      Agents, Models, RAG, Tools, Server, CLI, Examples.
    expected_result: >
      A DocPlan JSON listing all pages with their titles and target paths.
    tools: []
    mode: structured
    output_schema: neurosurfer.docs.schemas.DocPlan
    export: true

  # 4) Generate per-page content
  - id: generate_pages
    depends_on: ["plan_docs"]
    purpose: >
      Generate or refresh markdown pages according to the DocPlan.
    goal: >
      For each DocPageSpec, use RAG over code and existing docs to
      produce a high-quality markdown page, then write it to disk.
    expected_result: >
      A summary of pages written (paths, titles, types).
    tools: ["code_search", "file_write"]
    mode: structured
    output_schema: neurosurfer.docs.schemas.DocGenerationReport
    export: true

  # 5) Build mkdocs nav
  - id: build_mkdocs_nav
    depends_on: ["plan_docs"]
    purpose: >
      Produce a mkdocs nav structure reflecting the new docs layout,
      preserving top-level sections like API Reference, Server, CLI, Examples.
    goal: >
      Generate a MkDocsNavSpec that can be merged into mkdocs.yml or
      written as a standalone file.
    expected_result: >
      A MkDocsNavSpec JSON object and a yaml string.
    tools: ["file_write"]
    mode: structured
    output_schema: neurosurfer.docs.schemas.MkDocsNavResult
    export: true

outputs:
  - generate_pages
  - build_mkdocs_nav
